<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ted.shiro_demo.mapper.BookIOMapper">
    <resultMap id="searchBookIO" type="com.ted.shiro_demo.entity.BookIO">
        <id column="id" property="id"/>
        <result column="user_name" property="userName"/>
        <result column="user_id" property="userId"/>
        <result column="name" property="name"/>
        <result column="books_id" property="booksId"/>
        <result column="number" property="number"/>
        <result column="borrow_time" property="borrowTime"/>
        <result column="return_time" property="returnTime"/>
    </resultMap>
    <select id="searchBookIO" resultMap="searchBookIO">
        SELECT bb.id,u.user_name,bb.user_id,b.name,bb.books_id,bb.number,bb.borrow_time,bb.return_time FROM
        `t_books` AS b INNER JOIN `t_user` AS u
        INNER JOIN borrow_books AS bb
        ON (bb.books_id = b.id AND u.id = bb.user_id)
        <trim prefix="where" prefixOverrides="and" suffixOverrides="and">
            <if test="userName != null and userName != ''">
                user_name = #{userName} and
            </if>
            <if test="bookName != null and bookName != ''">
                `name` = #{bookName} and
            </if>
            <choose>
                <when test="brType == 'borrow_time'">
                    `return_time` = '/' and
                </when>
                <when test="brType != 'borrow_time'">
                    `return_time` != '/' and
                </when>
            </choose>
            <choose>
                <when test="brType == 'borrow_time'">
                    <choose>
                        <when test="startTime != null and startTime != '' and endTime != null and endTime != ''">
                            borrow_time between ${startTime} and ${endTime}
                        </when>
                        <when test="startTime != null and startTime != ''">
                            borrow_time >= ${startTime}
                        </when>
                        <when test="endTime != null and endTime != ''">
                            borrow_time <![CDATA[ <= ]]> ${endTime}
                        </when>
                    </choose>
                </when>
                <when test="brType == 'return_time'">
                    <choose>
                        <when test="startTime != null and startTime != '' and endTime != null and endTime != ''">
                            return_time between ${startTime} and ${endTime}
                        </when>
                        <when test="startTime != null and startTime != ''">
                            return_time >= ${startTime}
                        </when>
                        <when test="endTime != null and endTime != ''">
                            return_time <![CDATA[ <= ]]> ${endTime}
                        </when>
                    </choose>
                </when>
            </choose>
        </trim>
    </select>
</mapper>